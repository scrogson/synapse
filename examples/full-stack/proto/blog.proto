syntax = "proto3";

package blog;

import "synapse/graphql/options.proto";
import "synapse/grpc/options.proto";
import "synapse/storage/options.proto";

// Entity definitions
import "blog.entities.proto";

// Auto-generated types (filters, connections, edges, PageInfo, OrderDirection)
import "blog.synapse.proto";

// =============================================================================
// Request/Response Messages
// =============================================================================

// Author service messages
message GetAuthorRequest {
  int64 id = 1;
}

message GetAuthorResponse {
  Author author = 1;
}

message ListAuthorsRequest {
  // Relay pagination
  optional string after = 1;
  optional string before = 2;
  optional int32 first = 3;
  optional int32 last = 4;
  // Filter & ordering
  optional AuthorFilter filter = 5;
  optional AuthorOrderBy order_by = 6;
}

message CreateAuthorRequest {
  int64 user_id = 1;      // Required: link to IAM User
  string pen_name = 2;
  optional string bio = 3;
}

message CreateAuthorResponse {
  Author author = 1;
}

message UpdateAuthorRequest {
  int64 id = 1;
  optional string pen_name = 2;
  optional string bio = 3;
  // Note: user_id is immutable after creation
}

message UpdateAuthorResponse {
  Author author = 1;
}

message DeleteAuthorRequest {
  int64 id = 1;
}

message DeleteAuthorResponse {
  bool success = 1;
}

// Post service messages
message GetPostRequest {
  int64 id = 1;
}

message GetPostResponse {
  Post post = 1;
}

message ListPostsRequest {
  // Relay pagination
  optional string after = 1;
  optional string before = 2;
  optional int32 first = 3;
  optional int32 last = 4;
  // Filter & ordering
  optional PostFilter filter = 5;
  optional PostOrderBy order_by = 6;
}

message CreatePostRequest {
  string title = 1;
  string content = 2;
  bool published = 3;
  int64 author_id = 4;
}

message CreatePostResponse {
  Post post = 1;
}

message UpdatePostRequest {
  int64 id = 1;
  optional string title = 2;
  optional string content = 3;
  optional bool published = 4;
  optional int64 author_id = 5;
}

message UpdatePostResponse {
  Post post = 1;
}

message DeletePostRequest {
  int64 id = 1;
}

message DeletePostResponse {
  bool success = 1;
}

// =============================================================================
// Services
// =============================================================================

service AuthorService {
  option (synapse.graphql.service) = {};
  option (synapse.grpc.service) = {};
  option (synapse.storage.service) = {
    generate_storage: true
    generate_implementation: true
  };

  // Get an author by ID
  rpc GetAuthor(GetAuthorRequest) returns (GetAuthorResponse) {
    option (synapse.graphql.query) = {
      name: "author"
      output_type: "Author"
      output_field: "author"
    };
  }

  // List authors with pagination
  rpc ListAuthors(ListAuthorsRequest) returns (AuthorConnection) {
    option (synapse.graphql.query) = {
      name: "authors"
    };
  }

  // Create a new author
  rpc CreateAuthor(CreateAuthorRequest) returns (CreateAuthorResponse) {
    option (synapse.graphql.mutation) = {
      name: "createAuthor"
      output_type: "Author"
      output_field: "author"
    };
  }

  // Update an existing author
  rpc UpdateAuthor(UpdateAuthorRequest) returns (UpdateAuthorResponse) {
    option (synapse.graphql.mutation) = {
      name: "updateAuthor"
      output_type: "Author"
      output_field: "author"
    };
  }

  // Delete an author
  rpc DeleteAuthor(DeleteAuthorRequest) returns (DeleteAuthorResponse) {
    option (synapse.graphql.mutation) = {
      name: "deleteAuthor"
    };
  }
}

service PostService {
  option (synapse.graphql.service) = {};
  option (synapse.grpc.service) = {};
  option (synapse.storage.service) = {
    generate_storage: true
    generate_implementation: true
  };

  // Get a post by ID
  rpc GetPost(GetPostRequest) returns (GetPostResponse) {
    option (synapse.graphql.query) = {
      name: "post"
      output_type: "Post"
      output_field: "post"
    };
  }

  // List posts with pagination
  rpc ListPosts(ListPostsRequest) returns (PostConnection) {
    option (synapse.graphql.query) = {
      name: "posts"
    };
  }

  // Create a new post
  rpc CreatePost(CreatePostRequest) returns (CreatePostResponse) {
    option (synapse.graphql.mutation) = {
      name: "createPost"
      output_type: "Post"
      output_field: "post"
    };
  }

  // Update an existing post
  rpc UpdatePost(UpdatePostRequest) returns (UpdatePostResponse) {
    option (synapse.graphql.mutation) = {
      name: "updatePost"
      output_type: "Post"
      output_field: "post"
    };
  }

  // Delete a post
  rpc DeletePost(DeletePostRequest) returns (DeletePostResponse) {
    option (synapse.graphql.mutation) = {
      name: "deletePost"
    };
  }
}
