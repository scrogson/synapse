syntax = "proto3";

package blog;

import "google/protobuf/timestamp.proto";
import "synapse/graphql/options.proto";
import "synapse/grpc/options.proto";
import "synapse/storage/options.proto";

// =============================================================================
// Entities
// =============================================================================

// User entity
message User {
  option (synapse.graphql.message) = { node: true };
  option (synapse.storage.entity) = {
    table_name: "users"
    relations: [
      {
        name: "posts"
        type: RELATION_TYPE_HAS_MANY
        related: "Post"
        foreign_key: "author_id"
      }
    ]
  };

  int64 id = 1 [(synapse.storage.column) = {
    primary_key: true
    auto_increment: true
  }];

  string email = 2 [(synapse.storage.column) = { unique: true }];
  string name = 3;
  optional string bio = 4;

  google.protobuf.Timestamp created_at = 5 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];

  google.protobuf.Timestamp updated_at = 6 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];
}

// Post entity
message Post {
  option (synapse.graphql.message) = { node: true };
  option (synapse.storage.entity) = {
    table_name: "posts"
    relations: [
      {
        name: "author"
        type: RELATION_TYPE_BELONGS_TO
        related: "User"
        foreign_key: "author_id"
        references: "id"
      }
    ]
  };

  int64 id = 1 [(synapse.storage.column) = {
    primary_key: true
    auto_increment: true
  }];

  string title = 2;
  string content = 3;
  bool published = 4;

  int64 author_id = 5 [(synapse.graphql.field).skip = true];

  google.protobuf.Timestamp created_at = 6 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];

  google.protobuf.Timestamp updated_at = 7 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];
}

// =============================================================================
// Filter & OrderBy Types (proto definitions - GraphQL wrappers auto-generated)
// =============================================================================

message StringFilter {
  optional string eq = 1;
  optional string ne = 2;
  optional string contains = 3;
  optional string starts_with = 4;
  optional string ends_with = 5;
}

message BoolFilter {
  optional bool eq = 1;
}

message IntFilter {
  optional int64 eq = 1;
  optional int64 ne = 2;
  optional int64 gt = 3;
  optional int64 gte = 4;
  optional int64 lt = 5;
  optional int64 lte = 6;
  repeated int64 in = 7;
}

enum OrderDirection {
  ORDER_DIRECTION_UNSPECIFIED = 0;
  ASC = 1;
  DESC = 2;
}

message UserFilter {
  optional IntFilter id = 1;
  optional StringFilter email = 2;
  optional StringFilter name = 3;
  optional StringFilter bio = 4;
}

message UserOrderBy {
  optional OrderDirection id = 1;
  optional OrderDirection email = 2;
  optional OrderDirection name = 3;
  optional OrderDirection created_at = 4;
  optional OrderDirection updated_at = 5;
}

message PostFilter {
  optional IntFilter id = 1;
  optional StringFilter title = 2;
  optional StringFilter content = 3;
  optional BoolFilter published = 4;
  optional IntFilter author_id = 5;
}

message PostOrderBy {
  optional OrderDirection id = 1;
  optional OrderDirection title = 2;
  optional OrderDirection published = 3;
  optional OrderDirection created_at = 4;
  optional OrderDirection updated_at = 5;
}

// =============================================================================
// Connection Types (proto definitions - GraphQL wrappers auto-generated)
// =============================================================================

message PageInfo {
  bool has_next_page = 1;
  bool has_previous_page = 2;
  optional string start_cursor = 3;
  optional string end_cursor = 4;
}

message UserEdge {
  string cursor = 1;
  User node = 2;
}

message UserConnection {
  repeated UserEdge edges = 1;
  PageInfo page_info = 2;
}

message PostEdge {
  string cursor = 1;
  Post node = 2;
}

message PostConnection {
  repeated PostEdge edges = 1;
  PageInfo page_info = 2;
}

// =============================================================================
// Request/Response Messages
// =============================================================================

// User CRUD
message GetUserRequest {
  int64 id = 1;
}

message GetUserResponse {
  User user = 1;
}

message ListUsersRequest {
  // Relay pagination
  optional string after = 1;
  optional string before = 2;
  optional int32 first = 3;
  optional int32 last = 4;
  // Filter & ordering
  optional UserFilter filter = 5;
  optional UserOrderBy order_by = 6;
}

message CreateUserRequest {
  string email = 1;
  string name = 2;
  optional string bio = 3;
}

message CreateUserResponse {
  User user = 1;
}

message UpdateUserRequest {
  int64 id = 1;
  optional string email = 2;
  optional string name = 3;
  optional string bio = 4;
}

message UpdateUserResponse {
  User user = 1;
}

message DeleteUserRequest {
  int64 id = 1;
}

message DeleteUserResponse {
  bool success = 1;
}

// Post CRUD
message GetPostRequest {
  int64 id = 1;
}

message GetPostResponse {
  Post post = 1;
}

message ListPostsRequest {
  // Relay pagination
  optional string after = 1;
  optional string before = 2;
  optional int32 first = 3;
  optional int32 last = 4;
  // Filter & ordering
  optional PostFilter filter = 5;
  optional PostOrderBy order_by = 6;
}

message CreatePostRequest {
  string title = 1;
  string content = 2;
  bool published = 3;
  int64 author_id = 4;
}

message CreatePostResponse {
  Post post = 1;
}

message UpdatePostRequest {
  int64 id = 1;
  optional string title = 2;
  optional string content = 3;
  optional bool published = 4;
}

message UpdatePostResponse {
  Post post = 1;
}

message DeletePostRequest {
  int64 id = 1;
}

message DeletePostResponse {
  bool success = 1;
}

// =============================================================================
// Services
// =============================================================================

service UserService {
  option (synapse.graphql.service) = {};
  option (synapse.grpc.service) = {};
  option (synapse.storage.service) = {
    generate_storage: true
    generate_implementation: true
  };

  // Queries
  rpc GetUser(GetUserRequest) returns (GetUserResponse) {
    option (synapse.graphql.method) = {
      name: "user"
      description: "Get a user by ID"
      operation: "Query"
      output_type: "User"
      output_field: "user"
    };
  }

  rpc ListUsers(ListUsersRequest) returns (UserConnection) {
    option (synapse.graphql.method) = {
      name: "users"
      description: "List users with pagination"
      operation: "Query"
    };
  }

  // Mutations
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse) {
    option (synapse.graphql.method) = {
      name: "createUser"
      description: "Create a new user"
      operation: "Mutation"
      output_type: "User"
      output_field: "user"
    };
  }

  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse) {
    option (synapse.graphql.method) = {
      name: "updateUser"
      description: "Update an existing user"
      operation: "Mutation"
      output_type: "User"
      output_field: "user"
    };
  }

  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse) {
    option (synapse.graphql.method) = {
      name: "deleteUser"
      description: "Delete a user"
      operation: "Mutation"
    };
  }
}

service PostService {
  option (synapse.graphql.service) = {};
  option (synapse.grpc.service) = {};
  option (synapse.storage.service) = {
    generate_storage: true
    generate_implementation: true
  };

  // Queries
  rpc GetPost(GetPostRequest) returns (GetPostResponse) {
    option (synapse.graphql.method) = {
      name: "post"
      description: "Get a post by ID"
      operation: "Query"
      output_type: "Post"
      output_field: "post"
    };
  }

  rpc ListPosts(ListPostsRequest) returns (PostConnection) {
    option (synapse.graphql.method) = {
      name: "posts"
      description: "List posts with pagination"
      operation: "Query"
    };
  }

  // Mutations
  rpc CreatePost(CreatePostRequest) returns (CreatePostResponse) {
    option (synapse.graphql.method) = {
      name: "createPost"
      description: "Create a new post"
      operation: "Mutation"
      output_type: "Post"
      output_field: "post"
    };
  }

  rpc UpdatePost(UpdatePostRequest) returns (UpdatePostResponse) {
    option (synapse.graphql.method) = {
      name: "updatePost"
      description: "Update an existing post"
      operation: "Mutation"
      output_type: "Post"
      output_field: "post"
    };
  }

  rpc DeletePost(DeletePostRequest) returns (DeletePostResponse) {
    option (synapse.graphql.method) = {
      name: "deletePost"
      description: "Delete a post"
      operation: "Mutation"
    };
  }
}
