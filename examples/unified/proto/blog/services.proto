syntax = "proto3";

package blog;

import "synapse/graphql/options.proto";
import "synapse/grpc/options.proto";
import "synapse/storage/options.proto";
import "synapse/validate/options.proto";
import "synapse/relay/types.proto";
import "blog/entities.proto";

// =============================================================================
// Filter & Connection Types
// =============================================================================

message AuthorFilter {
  optional synapse.relay.IntFilter id = 1;
  optional synapse.relay.IntFilter user_id = 2;
  optional synapse.relay.StringFilter pen_name = 3;
  optional synapse.relay.StringFilter bio = 4;
  optional synapse.relay.TimestampFilter created_at = 5;
  optional synapse.relay.TimestampFilter updated_at = 6;
  repeated AuthorFilter and = 7;
  repeated AuthorFilter or = 8;
  optional AuthorFilter not = 9;
}

message AuthorOrderBy {
  optional synapse.relay.OrderDirection id = 1;
  optional synapse.relay.OrderDirection user_id = 2;
  optional synapse.relay.OrderDirection pen_name = 3;
  optional synapse.relay.OrderDirection bio = 4;
  optional synapse.relay.OrderDirection created_at = 5;
  optional synapse.relay.OrderDirection updated_at = 6;
}

message AuthorEdge {
  string cursor = 1;
  Author node = 2;
}

message AuthorConnection {
  repeated AuthorEdge edges = 1;
  synapse.relay.PageInfo page_info = 2;
}

message PostFilter {
  optional synapse.relay.IntFilter id = 1;
  optional synapse.relay.StringFilter title = 2;
  optional synapse.relay.StringFilter content = 3;
  optional synapse.relay.BoolFilter published = 4;
  optional synapse.relay.IntFilter author_id = 5;
  optional synapse.relay.TimestampFilter created_at = 6;
  optional synapse.relay.TimestampFilter updated_at = 7;
  repeated PostFilter and = 8;
  repeated PostFilter or = 9;
  optional PostFilter not = 10;
}

message PostOrderBy {
  optional synapse.relay.OrderDirection id = 1;
  optional synapse.relay.OrderDirection title = 2;
  optional synapse.relay.OrderDirection content = 3;
  optional synapse.relay.OrderDirection author_id = 4;
  optional synapse.relay.OrderDirection created_at = 5;
  optional synapse.relay.OrderDirection updated_at = 6;
}

message PostEdge {
  string cursor = 1;
  Post node = 2;
}

message PostConnection {
  repeated PostEdge edges = 1;
  synapse.relay.PageInfo page_info = 2;
}

// =============================================================================
// Request/Response Messages
// =============================================================================

message GetAuthorRequest {
  int64 id = 1;
}

message GetAuthorResponse {
  Author author = 1;
}

message ListAuthorsRequest {
  optional string after = 1;
  optional string before = 2;
  optional int32 first = 3;
  optional int32 last = 4;
  optional AuthorFilter filter = 5;
  optional AuthorOrderBy order_by = 6;
}

message CreateAuthorRequest {
  option (synapse.validate.message) = {
    generate_conversion: true
    name: "CreateAuthor"
  };

  // Automatically set to the current authenticated user's ID
  // Not exposed in GraphQL input - populated server-side from auth context
  int64 user_id = 1 [(synapse.graphql.field).from_context = {
    path: "current_user.id"
    required: true
  }];

  string pen_name = 2 [(synapse.validate.field).rules = {
    required: true
    length: { min: 1, max: 100 }
  }];
  optional string bio = 3 [(synapse.validate.field).rules = {
    length: { max: 1000 }
  }];
}

message CreateAuthorResponse {
  Author author = 1;
}

message UpdateAuthorRequest {
  option (synapse.validate.message) = {
    generate_conversion: true
    name: "UpdateAuthor"
  };

  int64 id = 1 [(synapse.validate.field).rules = {
    required: true
  }];
  optional string pen_name = 2 [(synapse.validate.field).rules = {
    length: { min: 1, max: 100 }
  }];
  optional string bio = 3 [(synapse.validate.field).rules = {
    length: { max: 1000 }
  }];
}

message UpdateAuthorResponse {
  Author author = 1;
}

message DeleteAuthorRequest {
  int64 id = 1;
}

message DeleteAuthorResponse {
  bool success = 1;
}

message GetPostRequest {
  int64 id = 1;
}

message GetPostResponse {
  Post post = 1;
}

message ListPostsRequest {
  optional string after = 1;
  optional string before = 2;
  optional int32 first = 3;
  optional int32 last = 4;
  optional PostFilter filter = 5;
  optional PostOrderBy order_by = 6;
}

message CreatePostRequest {
  option (synapse.validate.message) = {
    generate_conversion: true
    name: "CreatePost"
  };

  string title = 1 [(synapse.validate.field).rules = {
    required: true
    length: { min: 1, max: 200 }
  }];
  string content = 2 [(synapse.validate.field).rules = {
    required: true
    length: { min: 1 }
  }];
  bool published = 3;
  int64 author_id = 4 [(synapse.validate.field).rules = {
    required: true
  }];
}

message CreatePostResponse {
  Post post = 1;
}

message UpdatePostRequest {
  option (synapse.validate.message) = {
    generate_conversion: true
    name: "UpdatePost"
  };

  int64 id = 1 [(synapse.validate.field).rules = {
    required: true
  }];
  optional string title = 2 [(synapse.validate.field).rules = {
    length: { min: 1, max: 200 }
  }];
  optional string content = 3 [(synapse.validate.field).rules = {
    length: { min: 1 }
  }];
  optional bool published = 4;
}

message UpdatePostResponse {
  Post post = 1;
}

message DeletePostRequest {
  int64 id = 1;
}

message DeletePostResponse {
  bool success = 1;
}

// =============================================================================
// Services
// =============================================================================

service AuthorService {
  option (synapse.graphql.service) = {};
  option (synapse.grpc.service) = {};
  option (synapse.storage.service) = {
    generate_storage: true
    generate_implementation: true
  };

  // Get an author by ID
  rpc GetAuthor(GetAuthorRequest) returns (GetAuthorResponse) {
    option (synapse.graphql.query) = {
      name: "author"
      output_type: "Author"
      output_field: "author"
    };
  }

  // List authors with pagination
  rpc ListAuthors(ListAuthorsRequest) returns (AuthorConnection) {
    option (synapse.graphql.query) = {
      name: "authors"
    };
  }

  // Create a new author
  rpc CreateAuthor(CreateAuthorRequest) returns (CreateAuthorResponse) {
    option (synapse.graphql.mutation) = {
      name: "createAuthor"
      output_type: "Author"
      output_field: "author"
    };
  }

  // Update an existing author
  rpc UpdateAuthor(UpdateAuthorRequest) returns (UpdateAuthorResponse) {
    option (synapse.graphql.mutation) = {
      name: "updateAuthor"
      output_type: "Author"
      output_field: "author"
    };
  }

  // Delete an author
  rpc DeleteAuthor(DeleteAuthorRequest) returns (DeleteAuthorResponse) {
    option (synapse.graphql.mutation) = {
      name: "deleteAuthor"
    };
  }
}

service PostService {
  option (synapse.graphql.service) = {};
  option (synapse.grpc.service) = {};
  option (synapse.storage.service) = {
    generate_storage: true
    generate_implementation: true
  };

  // Get a post by ID
  rpc GetPost(GetPostRequest) returns (GetPostResponse) {
    option (synapse.graphql.query) = {
      name: "post"
      output_type: "Post"
      output_field: "post"
    };
  }

  // List posts with pagination
  rpc ListPosts(ListPostsRequest) returns (PostConnection) {
    option (synapse.graphql.query) = {
      name: "posts"
    };
  }

  // Create a new post
  rpc CreatePost(CreatePostRequest) returns (CreatePostResponse) {
    option (synapse.graphql.mutation) = {
      name: "createPost"
      output_type: "Post"
      output_field: "post"
    };
  }

  // Update an existing post
  rpc UpdatePost(UpdatePostRequest) returns (UpdatePostResponse) {
    option (synapse.graphql.mutation) = {
      name: "updatePost"
      output_type: "Post"
      output_field: "post"
    };
  }

  // Delete a post
  rpc DeletePost(DeletePostRequest) returns (DeletePostResponse) {
    option (synapse.graphql.mutation) = {
      name: "deletePost"
    };
  }
}
