syntax = "proto3";

package blog;

import "google/protobuf/timestamp.proto";
import "synapse/graphql/options.proto";
import "synapse/storage/options.proto";
import "iam/entities.proto";

// =============================================================================
// Blog Entities
// =============================================================================

// Author - a blog author profile linked to an IAM User
message Author {
  option (synapse.graphql.message) = { node: true };
  option (synapse.storage.entity) = {
    table_name: "authors"
    relations: [
      {
        name: "user"
        type: RELATION_TYPE_BELONGS_TO
        related: "iam.User"
        foreign_key: "user_id"
        references: "id"
      },
      {
        name: "posts"
        type: RELATION_TYPE_HAS_MANY
        related: "Post"
        foreign_key: "author_id"
      }
    ]
  };

  int64 id = 1 [(synapse.storage.column) = {
    primary_key: true
    auto_increment: true
  }];

  // Foreign key to IAM User (the identity/auth record)
  int64 user_id = 2 [(synapse.graphql.field).skip = true];

  // Author-specific fields
  string pen_name = 3;
  optional string bio = 4;

  google.protobuf.Timestamp created_at = 5 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];

  google.protobuf.Timestamp updated_at = 6 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];
}

// Post - a blog post written by an author
message Post {
  option (synapse.graphql.message) = { node: true };
  option (synapse.storage.entity) = {
    table_name: "posts"
    relations: [
      {
        name: "author"
        type: RELATION_TYPE_BELONGS_TO
        related: "Author"
        foreign_key: "author_id"
        references: "id"
      }
    ]
  };

  int64 id = 1 [(synapse.storage.column) = {
    primary_key: true
    auto_increment: true
  }];

  string title = 2;
  string content = 3;
  bool published = 4;

  int64 author_id = 5 [(synapse.graphql.field).skip = true];

  google.protobuf.Timestamp created_at = 6 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];

  google.protobuf.Timestamp updated_at = 7 [(synapse.storage.column) = {
    default_expr: "Expr::current_timestamp()"
  }];
}
